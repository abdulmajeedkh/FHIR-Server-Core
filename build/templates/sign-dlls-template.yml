# Repo: FirelyTeam/firely-net-sdk
# File: build/templates/signing-dlls-template-template.yml

steps:
  - task: DownloadSecureFile@1
    displayName: Download Signing key file
    inputs:
      secureFile: 47f5a9d4-7009-4fe1-9cb2-c0d6122ded23
      retryCount: 
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest')) # not a PR
  - task: CopyFiles@2
    displayName: Copy key file to $(Build.SourcesDirectory)/src
    inputs:
      SourceFolder: $(Agent.TempDirectory)
      Contents: FhirNetApi.snk
      TargetFolder: $(Build.SourcesDirectory)/src
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest')) # not a PR
  - powershell: |
        $sdkfiles   =  Get-ChildItem -Path $(Build.SourcesDirectory)\src\Hl7.Fhir*\bin\Release\*\Hl7.Fhir*.dll -Exclude Hl7.Fhir*Tests

        Write-Host "##[section]Starting DLL signing process..."
        Write-Host "##[debug]Last exitcode before signing: $lastexitcode"
        
        $fileCount = $sdkfiles.Count
        $currentFile = 0
        
        foreach ($file in ($sdkfiles))
        {
          $currentFile++
          Write-Host "##[command]Signing file ($currentFile/$fileCount): $($file.Name)"
          Write-Host "##[debug]Full path: $file"

          & '$(Build.SourcesDirectory)\build\tools\sn.exe' -R $file $(Build.SourcesDirectory)\src\FhirNetApi.snk
          
          if ($lastexitcode -eq 0) {
            Write-Host "##[section]✓ Successfully signed: $($file.Name)"
          } else {
            Write-Host "##[warning]⚠ Exit code after signing $($file.Name): $lastexitcode"
          }
        }
        
        Write-Host "##[section]DLL signing process completed! Signed $fileCount files."
        Write-Host "##[debug]Final exitcode: $lastexitcode"
        
        # suppress exitcode 
        if ($lastexitcode -lt 2) { $global:lastexitcode = 0 }
    displayName: Signing the dlls
    name: signing
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest')) # not a PR
  
